import fs from "fs";
import { join, dirname, extname } from "path";
import hasha from "hasha";

const assetCache = new Map();
const regex = /(\.\.?\/[\w+-_\/?]+\.\w+)/g;

export function processPost(file) {
  if (!fs.existsSync(file)) return null;
  const markdown = fs.readFileSync(file, "utf-8");
  return markdown.replace(regex, function(match) {
    const requiredFile = join(dirname(file), match);
    if (assetCache.has(requiredFile)) {
      return assetCache.get(requiredFile);
    }
    if (fs.existsSync(requiredFile)) {
      const fileHash = hasha.fromFileSync(requiredFile);
      const publicFile = join(
        "assets",
        fileHash.slice(0, 10) + extname(requiredFile)
      );
      const assetFile = join("static", publicFile);
      if (!fs.existsSync(assetFile)) {
        fs.copyFileSync(requiredFile, assetFile);
      }
      assetCache.set(requiredFile, publicFile);
      return publicFile;
    }

    return match;
  });
}
